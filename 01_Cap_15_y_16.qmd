---
title: "√Ånalisis de las encuestas de hodares con R"
subtitle: "C√°pitulos: Procesamiento longitudinal de las encuestas rotativas"
author: |
  | Andr√©s Guti√©rrez.
  | Stalyn Guerrero. 
institute: "CEPAL - Unidad de Estad√≠sticas Sociales"
format: 
  beamer: 
    colortheme: dove
    fonttheme: default
    incremental: false
    aspectratio: 1610
    #theme: Berkeley
    toc: true
    slide_level: 2
    #highlight: pygments
Email: andres.gutierrez@cepal.org
lang: es
editor_options:
  markdown:
    wrap: 90
bibliography: CEPAL.bib
---

```{r, echo=FALSE}
input <- "Data"
```

# Procesamiento longitudinal de las encuestas rotativas

## Introducci√≥n 


### ¬øPor qu√© pensar en procesamiento longitudinal?


- Algunas oficinas requieren estad√≠sticas de seguimiento continuo.

- Se aprovecha el esquema rotativo para generar informaci√≥n longitudinal.

- Requiere estructura de ponderaci√≥n espec√≠fica.



### ¬øQu√© es una encuesta longitudinal?

* Recolecta informaci√≥n sobre los mismos elementos en m√∫ltiples momentos.

* Contrasta con levantamientos transversales.

* Un ejemplo: esquema rotativo 4(1)0 permite seguimiento anual de 25%.


## Introducci√≥n  

> Seg√∫n @Lynn_2009, una encuesta longitudinal observa los mismos elementos a lo largo del tiempo. Muchas encuestas rotativas, como las de empleo, se pueden convertir en longitudinales si se estructura adecuadamente el seguimiento.




## Estimaci√≥n del cambio y la varianza


* El foco est√° en estimar cambios entre periodos consecutivos.

* Es necesario calcular:

  * Varianza del periodo 1
  
  * Varianza del periodo 2
  
  * Correlaci√≥n entre ambos
  
* Esos elementos afectan CV y tama√±o de muestra.

\

> "Uno de los retos metodol√≥gicos clave es que las muestras no son independientes. Para estimar cambios correctamente, debemos considerar la varianza en cada ronda y la correlaci√≥n entre observaciones repetidas."


# An√°lisis posibles con datos longitudinales


##  Caracterizaci√≥n de transiciones individuales

* Identificaci√≥n de hogares/personas que cambian de estatus.

* An√°lisis de las caracter√≠sticas de quienes _entran o salen_ de situaciones como la pobreza extrema, incluso sin cambios netos agregados.

 _Estabilidad e inestabilidad en el tiempo_

* Seguimiento prolongado permite detectar *trayectorias persistentes* o *fluctuaciones*.
* Comprensi√≥n m√°s profunda de los factores que **explican la permanencia en condiciones como la pobreza extrema**.


## Duraci√≥n, eventos e impactos

### Caracterizaci√≥n de eventos y duraci√≥n

- Estudio de la *duraci√≥n de estados*: cu√°nto tiempo se permanece desempleado, inactivo, fuera del sistema educativo, etc.

- Posibilidad de construir *indicadores de duraci√≥n y persistencia*.

###  Evaluaci√≥n de impactos y relaciones causales

- Estimaci√≥n del **efecto de intervenciones** o choques externos (ej. COVID-19) sobre fen√≥menos como la **desocupaci√≥n**.

## Dise√±o de paneles rotativos en encuestas de hogares

- En Am√©rica Latina, varias encuestas de hogares incorporan esquemas de panel rotativo que permiten la observaci√≥n repetida de una misma unidad de an√°lisis.

- Este dise√±o busca:

  - Capturar din√°micas intra-hogar e interpersonales a lo largo del tiempo.
  
  - Generar estimaciones robustas sobre cambios de estado (e.g., ocupaci√≥n ‚Üî inactividad).
  
- La dimensi√≥n longitudinal se configura sobre los hogares que __respondieron efectivamente en m√°s de un periodo__, permitiendo an√°lisis m√°s all√° de los cortes transversales.



## Traslapes muestrales en un esquema 4(0)1

- Una encuesta con dise√±o **4(0)1** realiza cuatro observaciones trimestrales consecutivas por vivienda antes de su rotaci√≥n definitiva.

- La rotaci√≥n de paneles genera **traslapes sistem√°ticos** entre periodos consecutivos:

  - **T1 vs T2 ‚Üí 75%** de hogares compartidos.
  - **T1 vs T3 ‚Üí 50%**
  - **T1 vs T4 ‚Üí 25%**
  - **T1 vs T5 ‚Üí 0%** (panel completamente renovado).
  
* Esta propiedad escalonada permite construir **bases longitudinales de corto, mediano y largo plazo**, dependiendo del objetivo anal√≠tico.

## Traslapes muestrales en un esquema 4(0)1


| Trimestre | Panel 1  | Panel 2  | Panel 3  | Panel 4  |
| --------- | -------- | -------- | -------- | -------- |
| T1        | $a_1$ | $b_1$ | $c_1$ | $d_1$ |
| T2        | $b_1$ | $c_1$ | $d_1$ | $a_2$ |
| T3        | $c_1$ | $d_1$ | $a_2$ | $b_2$ |
| T4        | $d_1$ | $a_2$ | $b_2$ | $c_2$ |
| T5        | $a_2$ | $b_2$ | $c_2$ | $d_2$ |
| T6        | $b_2$ | $c_2$ | $d_2$ | $a_3$ |

Table: *Rotaci√≥n de p√°neles para un dise√±o 4(0)1.*


## Construcci√≥n de esquemas longitudinales en paneles rotativos

La figura ilustra tres esquemas longitudinales que pueden derivarse del dise√±o rotativo:

1. **Bimestral (T1‚ÄìT2):**

2. **Trimestral extendido (T1‚ÄìT3):**

3. **Anual (T1‚ÄìT4):**


![Tres escenarios longitudinales en un esquema rotativo 4(0)1.](Imagenes/15_cap/el1.png){width="400"}


## Efectos del COVID-19 en el esquema rotativo ‚Äì A√±o 2020

- El a√±o 2020 represent√≥ un quiebre en la operatividad normal de los levantamientos debido a la emergencia sanitaria provocada por el COVID-19.

- Las *restricciones de movilidad* obligaron a:

  - Cambiar el modo de recolecci√≥n a entrevistas **telef√≥nicas**, reduciendo la cobertura y la tasa de respuesta efectiva.
  
  - *Repetir el dise√±o muestral* del primer trimestre en el tercer trimestre, lo que alter√≥ la l√≥gica original de rotaci√≥n 4(0)1.


## Esquema observado:

|  A√±o | Trimestre |  Panel 1 |  Panel 2 |  Panel 3 |  Panel 4 |
| :--: | :-------: | :------: | :------: | :------: | :------: |
| 2020 |     T1    | $a_1$ | $b_1$ | $c_1$ | $d_1$ |
|      |     T2    | $b_1$ | $c_1$ | $d_1$ | $a_2$ |
|      |     T3    | $b_1$ | $c_1$ | $d_1$ | $a_2$ |
|      |     T4    | $c_1$ | $d_1$ | $a_2$ | $b_2$ |

**Implicaciones en el traslape muestral:**

- **T2 vs T3:** 100% de traslape.

- **T1 vs T3:** 75% de traslape.

- **T1 vs T4:** 50% de traslape.


## Cargue de base de datos y librerias {.smaller}

\small

```{r, lectura_data, echo=TRUE, warning=FALSE, error=FALSE, message=FALSE, eval=FALSE}
library(printr)     # Mejora la presentaci√≥n de tablas en documentos RMarkdown
library(tidyverse)  # Conjunto de paquetes para manipulaci√≥n y
                    # visualizaci√≥n de datos
library(tidyr)      # Manejo de estructuras anchas/largas 
library(pROC)       # Curvas ROC 
library(survey)     # An√°lisis de encuestas con dise√±o muestral complejo

# Carga de la base de datos a nivel de personas
base_personas <- readRDS(file.path(input, "base_personas.rds")) %>%
  ungroup()  # Elimina cualquier agrupamiento previo

# Creaci√≥n de la base a nivel de hogares, extrayendo variables
# clave sin duplicados

base_hogares <- base_personas %>%
  distinct(upm, trimestre, id_hogar, fep)

# Visualizaci√≥n preliminar de la base de hogares
head(base_hogares, 10)

```

## Cargue de base de datos y librerias {.smaller}

```{r, lectura_data, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
```


## Muestra de UPMs por trimestre {.smaller}

-   N√∫mero de hogares por trimestre
```{r, echo=TRUE}
base_hogares %>%   group_by(trimestre) %>%
  tally(name = "hogares")
```

-   N√∫mero de UPMs √∫nicas por trimestre

```{r, echo=TRUE}
base_hogares %>%   distinct(trimestre, upm) %>%
  group_by(trimestre) %>%   tally(name = "upm")

```

## N√∫mero de UPMs en el traslape   {.smaller}

### Paso 1: identificar hogares que aparecen en ambos trimestres

```{r, echo=TRUE}
# Identifica hogares que aparecen exactamente en dos trimestres
hogares_ambos <- base_hogares %>%
  group_by(id_hogar) %>%
  count() %>%  filter(n == 2) %>%  # Aparecen en dos trimestres
  pull(id_hogar)

# Extrae los pesos del trimestre 1 para los hogares que ser√°n comparados
base_t1 <- base_hogares %>%
  filter(trimestre == "t1") %>%   select(id_hogar, fep_t1 = fep)

# N√∫mero total de hogares con traslape en dos trimestres
length(hogares_ambos)

```


## Fundamentos para la generaci√≥n de bases longitudinales

- El an√°lisis longitudinal permite observar transiciones individuales o de hogares entre estados (ocupaci√≥n, pobreza, etc.) y **no es viable en todas las encuestas**, solo en aquellas con **esquemas rotativos** planificados.

- Es posible construir **tablas de transici√≥n** entre dos periodos a partir de observaciones empalmadas de la misma unidad.

### Enfoque de estimaci√≥n de flujos brutos @Feinberg_Stasny_1983:

* Considera las diferencias entre pesos de muestreo en dos momentos como producto de la din√°mica poblacional (ingresos y salidas del marco).
* **Ejemplo ilustrativo:**

  * Si un individuo fue empleado en \$t-1\$ y \$t\$, y sus pesos fueron 300 y 305:

    * Se asigna 300 a la celda (Empleado‚ÄìEmpleado).
    * Se asigna 5 a (Fuera‚ÄìEmpleado).
  * Este enfoque **conserva el total poblacional** y respeta los cambios reales observados.


### üìä **Slide 6: Procedimiento para generaci√≥n de pesos longitudinales**

**Metodolog√≠a (Verma, Betti & Ghellini):**

**1. Pesos iniciales (transversales):**

* Basados en el dise√±o muestral, ajustados por:

  * Probabilidad de selecci√≥n por panel.
  * No respuesta y cobertura.

**2. Pesos longitudinales (dos periodos):**

* Ajustes aplicados:

  * **Poblaci√≥n longitudinal efectiva** (hogares presentes en ambos periodos).
  * **Atrici√≥n muestral** (p√©rdida de casos por falta de seguimiento).
  * **Calibraci√≥n final** para alinear con totales poblacionales conocidos.

**Consideraciones t√©cnicas:**

* El tama√±o de la base longitudinal **disminuye** a medida que se incrementa el n√∫mero de periodos integrados (m√°ximo 4 en dise√±o 4(0)1).
* **Agrega mediciones, pero reduce unidades √∫nicas**: m√°s observaciones por individuo, menos individuos distintos.

> üí¨ *Comentario sugerido:*
> "Este proceso permite generar estimaciones longitudinales consistentes, controlando las p√©rdidas por atrici√≥n y garantizando comparabilidad intertemporal."

---

¬øDeseas que desarrolle una **tercera diapositiva** explicando c√≥mo implementar esto en R con c√≥digo para unir paneles y construir los pesos, o prefieres continuar con la siguiente secci√≥n te√≥rica del cap√≠tulo? Tambi√©n puedo ayudarte a armar una tabla con el flujo paso a paso como apoyo visual.



## ¬°Gracias!

::: yellow
*Email*: [andres.gutierrez\@cepal.org](mailto:andres.gutierrez@cepal.org){.email}
:::

## Referencias